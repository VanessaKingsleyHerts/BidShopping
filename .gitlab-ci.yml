stages:
  - build
  - lint
  - test
  - collect_logs

variables:
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED:    "1"
  POSTGRES_DB:         "bidshopping"
  POSTGRES_USER:       "postgres"
  POSTGRES_PASSWORD:   "postgres"
  DATABASE_URL:        "postgres://postgres:postgres@db:5432/bidshopping"
  STATIC_ROOT:         "/tmp/static"
  DOCKER_TLS_CERTDIR:  ""

# … build-image, lint, test jobs as before …

collect-logs:
  stage: collect_logs
  image: python:3.10
  before_script:
    - pip install requests pandas
  script:
    - python scripts/download_logs.py
    - python scripts/merge_ci_logs.py
    - echo ">>>> Pushing merged CSV via GitHub API"
    - pip install requests
    - python scripts/push_to_github.py
  only:
    - main
